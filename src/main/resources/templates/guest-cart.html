<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
  <title th:text="#{guestCart.title}">비회원 장바구니</title>
</head>

<body>
<div layout:fragment="content" class="container-fluid my-5">

  <!-- 페이지 제목 -->
  <h2 class="mb-4 text-center" th:text="#{guestCart.title}">비회원 장바구니</h2>

  <!-- 🛒 장바구니 테이블 -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-light">
      <tr>
        <th th:text="#{cart.header.productName}">상품명</th>
        <th th:text="#{cart.header.salePrice}">판매가</th>
        <th th:text="#{cart.header.quantity}">수량</th>
        <th th:text="#{cart.header.wrapping}">포장여부</th>
        <th th:text="#{cart.header.delete}">삭제</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item, stat : ${cartItems}">
        <!-- 상품명 + 이미지 -->
        <td style="max-width: 300px;">
          <div class="d-flex align-items-center gap-3">
            <a th:href="@{/books/{id}(id=${item.bookId})}">
              <img th:src="@{|${minioPath.book}${item.bookUrl}|}" alt="책 표지" class="img-thumbnail" style="width: 60px;">
            </a>
            <a th:href="@{/books/{id}(id=${item.bookId})}" class="text-decoration-none text-dark">
              <span th:text="${item.title}"></span>
            </a>
          </div>
        </td>

        <!-- 판매가 -->
        <td>
          <span th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA')} + '원'"></span>
        </td>

        <!-- 수량 변경 -->
        <td>
          <form th:action="@{/guest-cart/update/{id}(id=${item.bookId})}" method="post"
                class="d-flex align-items-center justify-content-center gap-2">
            <input type="hidden" name="_method" value="put"/>
            <input type="number" name="quantity" th:value="${item.quantity}" min="1"
                   class="form-control form-control-sm text-center" style="width: 80px;">
            <button type="submit" class="btn btn-outline-secondary btn-sm" th:text="#{cart.button.change}">변경</button>
          </form>
        </td>

        <!-- 포장 여부 -->
        <td>
          <select class="form-select form-select-sm wrapping-select" th:attr="data-index=${stat.index}">
            <option data-price="0" value="" th:text="#{cart.wrapping.noSelect}">선택 안 함</option>
            <option th:each="wrap : ${wrappingOptions}"
                    th:value="${wrap.id}"
                    th:data-price="${wrap.price}"
                    th:text="${wrap.name + ' (' + #numbers.formatInteger(wrap.price, 0, 'COMMA') + '원)'}">
            </option>
          </select>
        </td>

        <!-- 삭제 버튼 -->
        <td>
          <form th:action="@{/guest-cart/delete/{id}(id=${item.bookId})}" method="post">
            <button type="submit" class="btn btn-danger btn-sm" th:text="#{cart.button.delete}">삭제</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 🧾 주문 요약 및 주문하기 버튼 -->
  <form th:action="@{/order}" method="post" class="mt-5">
    <div class="card shadow-sm p-4">
      <div class="row align-items-center">

        <!-- 가격 요약 영역 -->
        <div class="col-md-8">
          <p class="fs-5 fw-semibold mb-2">
            <span th:text="#{cart.summary.totalProductPrice}">총 제품 금액</span>:
            <span id="totalProductPrice" class="ms-2">0원</span>
          </p>
          <p class="fs-5 fw-semibold mb-2">
            <span th:text="#{cart.summary.totalWrappingPrice}">총 포장 금액</span>:
            <span id="totalWrappingPrice" class="ms-2 text-warning">0원</span>
          </p>
          <p class="fs-5 fw-semibold">
            <span th:text="#{cart.summary.orderTotal}">총 주문 금액</span>:
            <span id="orderTotal" class="ms-2 fw-bold text-danger">0원</span>
          </p>
        </div>

        <!-- 주문 버튼 -->
        <div class="col-md-4 text-md-end text-center mt-3 mt-md-0">
          <button type="submit" class="btn btn-primary btn-lg px-5" th:text="#{cart.button.order}">주문하기</button>
        </div>
      </div>

      <!-- hidden DTO 필드 -->
      <div th:each="item, stat : ${cartItems}">
        <input type="hidden" th:name="|items[${stat.index}].bookId|" th:value="${item.bookId}"/>
        <input type="hidden" th:name="|items[${stat.index}].title|" th:value="${item.title}"/>
        <input type="hidden" th:name="|items[${stat.index}].price|" th:value="${item.salePrice}"/>
        <input type="hidden" th:name="|items[${stat.index}].quantity|" th:value="${item.quantity}"/>
        <input type="hidden" th:name="|items[${stat.index}].wrappingId|"/>
      </div>
    </div>
  </form>


</div>

<!-- 외부 스크립트 -->
<th:block layout:fragment="scripts">
  <script src="/js/guest-cart.js"></script>
</th:block>
</body>
</html>
