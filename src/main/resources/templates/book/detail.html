<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}">


<head>
    <title th:text="${book.title} + #{book.detail.title.suffix}">책 상세</title>
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>

<body>
<div layout:fragment="content">
    <div class="book-detail-container">
        <div class="book-header">
            <h1 th:text="${book.title}">책 제목</h1>
            <div class="book-meta"
                 th:text="${book.author} + #{book.meta.separator} + ${book.publisher} + #{book.meta.separator} + ${book.publishedAt}">
                저자 | 출판사 | 출판일
            </div>
        </div>

        <div class="book-content">
            <div class="book-image">
                <img th:src="@{|${minioPath.book}${book.bookUrls[0]}|}" th:alt="${book.title}">
            </div>

            <div class="book-detail">
                <div class="price-info">
                    <div>
                        <strong th:text="#{book.price.original}">정가:</strong>
                        <del th:text="${#numbers.formatInteger(book.regularPrice, 0, 'COMMA')} + '원'">정가</del>
                    </div>
                    <div>
                        <strong th:text="#{book.price.sale}">판매가:</strong>
                        <span style="color: #d32f2f;"
                              th:text="${#numbers.formatInteger(book.salePrice, 0, 'COMMA')} + '원'">판매가</span>
                        <span style="color: #388e3c; margin-left: 10px;"
                              th:with="discountAmount=${book.regularPrice - book.salePrice}"
                              th:text="#{book.price.discount.format(${book.discountRate}, ${#numbers.formatInteger(discountAmount, 0, 'COMMA')})}">
                            (10%, 2,000원 할인)
                        </span>

                    </div>

                    <div class="like-container">
                        <!-- 로그인 한 사용자 -->
                        <div th:if="${user != null}">
                            <form th:action="@{'/books/' + ${book.bookId} + '/like'}" method="post">
                                <button class="like-button"
                                        type="submit"
                                        th:classappend="${isLiked} ? ' liked' : ''"
                                        th:text="#{book.like.button}">
                                    ♡ 찜하기
                                </button>
                            </form>

                            <!-- 서버에서 전달한 메시지 출력 -->
                            <div th:if="${likeMsg}" class="like-message" style="color: red; margin-top: 5px;">
                                <p th:text="#{${likeMsg}}"></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <strong th:text="#{book.price.mileage}">마일리지:</strong> <!-- 값 필요 -->
                    </div>
                    <div>
                        <strong th:text="#{book.price.category}">카테고리??:</strong> <!-- 값 필요 -->
                    </div>
                    <div>
                        <strong>ISBN:</strong>
                        <span th:text="${book.isbn}">ISBN 값</span>
                    </div>
                </div>

                <!-- 별점 및 평점 -->
                <div class="rating">
                    <div class="stars">
                        <span th:each="i : ${#numbers.sequence(1, 5)}"
                              th:class="${i <= T(java.lang.Math).floor(reviewSummary.ratingAvg)} ? 'star filled' :
                                        (${reviewSummary.ratingAvg % 1 != 0 and i == T(java.lang.Math).floor(reviewSummary.ratingAvg) + 1} ? 'star half-filled' : 'star')">
                            ★
                        </span>
                    </div>
                    <span class="rating-text"
                          th:text="#{book.rating.label(${#numbers.formatDecimal(reviewSummary.ratingAvg, 1, 1)}, ${reviewSummary.reviewCount})}">
                        0.0 | 리뷰(0)
                    </span>
                </div>


                <div>
                    <strong th:text="#{book.quantity.label}">수량:</strong>
                    <div class="quantity-box">
                        <button type="button" onclick="changeQty(-1)">-</button>
                        <input type="text" id="quantity" value="1" readonly>
                        <button type="button" onclick="changeQty(1)">+</button>
                    </div>
                    <div class="total-price"
                         id="totalPrice"
                         th:text="#{book.price.total(${#numbers.formatInteger(book.salePrice, 0, 'COMMA')})}">
                        총 상품금액
                    </div>
                </div>

                <div class="btns">
                    <form th:action="@{/cart/add}" method="post" class="mt-2">
                        <input type="hidden" name="bookId" th:value="${book.bookId}"/>
                        <input type="hidden" name="quantity" value="1"/>
                        <button type="submit" class="btn btn-primary btn-sm">장바구니 담기</button>
                    </form>
                    <button class="btn-buy" th:text="#{button.buy}">바로구매</button>
                </div>
            </div>
        </div>


        <!-- 책 소개 -->
        <div class="book-intro">
            <div class="book-intro-title" th:text="#{book.intro.title}">책소개</div>
            <div class="book-intro-content" th:utext="${book.description}">책 소개 내용</div>
        </div>


        <!-- 리뷰 작성 -->

        <th:block sec:authorize="isAuthenticated()">
            <div class="review-write-section">
                <form th:action="@{'/books/' + ${book.bookId} + '/reviews'}"
                      method="post"
                      enctype="multipart/form-data"
                      class="review-write-inner">


                    <h2 th:text="#{review.write.title}">리뷰 작성</h2>

                    <div class="review-write-inner">
                        <div class="star-rating space-x-4 mx-auto">
                            <input type="radio" id="5-stars" name="rating" value="5" v-model="ratings"/>
                            <label for="5-stars" class="star pr-4">★</label>
                            <input type="radio" id="4-stars" name="rating" value="4" v-model="ratings"/>
                            <label for="4-stars" class="star">★</label>
                            <input type="radio" id="3-stars" name="rating" value="3" v-model="ratings"/>
                            <label for="3-stars" class="star">★</label>
                            <input type="radio" id="2-stars" name="rating" value="2" v-model="ratings"/>
                            <label for="2-stars" class="star">★</label>
                            <input type="radio" id="1-star" name="rating" value="1" v-model="ratings"/>
                            <label for="1-star" class="star">★</label>
                        </div>

                        <textarea name="content"
                                  th:placeholder="#{review.write.placeholder}"
                                  maxlength="200"
                                  wrap="soft"></textarea>

                        <div class="review-btns">
                            <button type="submit" th:text="#{button.review.submit}">등록</button>

                            <label class="upload-btn"> 이미지 업로드
                                <input type="file" name="files" multiple accept=".png, .jpeg, .jpg" onchange="updateFileNames(this)">
                            </label>
                        </div>

                        <div class="file-info-container">
                            <div id="file-names"></div>
                        </div>
                    </div>
                </form>
            </div>

        </th:block>


        <!-- 리뷰목록 -->
        <div class="review-section">
            <h2 th:text="#{review.my.title}">리뷰 목록</h2>

            <div class="filter-info"
                 th:text="#{review.count.label(${reviewCount})}">
                전체 (0)
            </div>
            <div class="review-list" id="review-list">
                <div class="review" th:each="review : ${reviews.content}">
                    <div class="review-header">
                        <strong th:text="${review.userId}">작성자</strong>
                        <span class="stars">
                    <span th:each="i : ${#numbers.sequence(1, 5)}"
                          th:class="${i <= review.rating} ? 'filled' : ''">★</span>
                </span>
                    </div>

                    <div class="review-content">
                        <p th:text="${review.content}">리뷰 내용</p>
                    </div>

                    <div class="review-images"
                         th:if="${review.images != null and !review.images.isEmpty()}">
                        <div class="image-gallery">
                            <div class="image-item"
                                 th:each="img, iterStat : ${review.images}">
                                <!-- 새 탭 버전 -->
                                <a th:href="@{|${minioPath.review}${img}|}"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="image-link">
                                    <img th:src="@{|${minioPath.review}${img}|}"
                                         th:alt="|리뷰 이미지 ${iterStat.index + 1}|"
                                         class="review-image">
                                    <div class="image-overlay"><span>새 탭</span></div>
                                </a>
                            </div>
                        </div>

                        <div class="image-count"
                             th:if="${#lists.size(review.images) > 3}">
                            <span th:text="|+${#lists.size(review.images) - 3} more|"></span>
                        </div>
                    </div>

                </div>
            </div>

            <input type="hidden" id="is-last" th:value="${reviews.last}">

            <div th:if="${!reviews.last}" style="text-align: center; margin-top: 1rem;">
                <button id="load-more-btn" type="button">더보기</button>
            </div>
        </div>



    </div>
</div>
<!-- JS -->


<div layout:fragment="scripts">
    <script th:inline="javascript">
        function updateFileNames(input) {
            const fileNamesDiv = document.getElementById('file-names');
            const files = Array.from(input.files);

            if (files.length === 0) {
                fileNamesDiv.textContent = '';
                return;
            }

            if (files.length === 1) {
                fileNamesDiv.textContent = `${files[0].name}`;
            } else {
                fileNamesDiv.textContent = `${files.length}개 파일 선택됨: ${files.map(f => f.name).join(', ')}`;
            }
        }

        const unitPrice = [[${book.salePrice}]];

        function changeQty(diff) {
            const input = document.getElementById("quantity");
            let qty = parseInt(input.value);
            qty += diff;
            if (qty < 1) qty = 1;
            input.value = qty;

            document.getElementById("totalPrice").innerText =
                '총 상품금액 ' + (qty * unitPrice).toLocaleString() + '원';
        }


        document.addEventListener("DOMContentLoaded", () => {
            let size = [[${size}]];
            const bookId = [[${book.bookId}]];


            // 장바구니 수량 전달 추가
            const cartForm = document.querySelector('form[action="/cart/add"]');
            cartForm.addEventListener('submit', function () {
                const qty = document.getElementById("quantity").value;
                const hiddenQtyInput = this.querySelector('input[name="quantity"]');
                hiddenQtyInput.value = qty;
            });


            // 리뷰 더보기 버튼
            document.getElementById('load-more-btn').addEventListener('click', () => {
                size += 5;

                const url = `/books/${bookId}?page=0&size=${size}`;

                fetch(url)
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        const newReviewList = doc.querySelector('#review-list');
                        const newReviewCount = doc.querySelector('#review-count');
                        const isLast = doc.querySelector('#is-last');

                        document.querySelector('#review-list').innerHTML = newReviewList.innerHTML;
                        document.querySelector('#review-count').innerText = newReviewCount.innerText;

                        if (isLast && isLast.value === 'true') {
                            document.getElementById('load-more-btn').style.display = 'none';
                        }
                    });
            });
        });
    </script>
</div>

</body>
</html>
