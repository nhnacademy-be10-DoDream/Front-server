<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title th:text="#{order.title}">주문서</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div layout:fragment="content" class="order-container" style="max-width: 900px; margin: 0 auto;">
    <form th:action="@{/order/payment}" method="post">
        <input type="hidden" name="userId" th:if="${user != null}" th:value="${user.userId}" />
        <div class="order-summary card shadow-sm p-4 mb-4">
            <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                <tr>
                    <th style="width: 45%;" th:text="#{order.summary.product}">상품명</th>
                    <th style="width: 10%;" th:text="#{order.summary.quantity}">수량</th>
                    <th style="width: 30%;" th:text="#{order.table.wrapping}">포장</th>
                    <th style="width: 15%;" th:text="#{order.summary.price}">금액</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item, iterStat : ${orderItems}">
                    <td th:text="${item.title}"></td>
                    <td th:text="${item.quantity}"></td>
                    <td>
                        <span th:text="${item.wrappingInfo == null || item.wrappingInfo.name == null ? '없음' : item.wrappingInfo.name}"></span>
                        <span th:if="${item.wrappingInfo != null and item.wrappingInfo.price != 0}"
                              th:text="|(+${#numbers.formatInteger(item.wrappingInfo.price, 0, 'COMMA')} #{order.currency.unit})|"></span>
                    </td>
                    <td th:text="|${#numbers.formatInteger(item.price, 0, 'COMMA')} #{order.currency.unit}|"></td>
                    <input type="hidden" th:name="|orderItems[${iterStat.index}].bookId|" th:value="${item.bookId}" />
                    <input type="hidden" th:name="|orderItems[${iterStat.index}].title|" th:value="${item.title}" />
                    <input type="hidden" th:name="|orderItems[${iterStat.index}].quantity|" th:value="${item.quantity}" />
                    <input type="hidden" th:name="|orderItems[${iterStat.index}].price|" th:value="${item.price}" />
                    <input type="hidden" th:name="|orderItems[${iterStat.index}].wrappingId|" th:value="${item.wrappingId}" />
                </tr>
                </tbody>
            </table>
    </div>
    <div class="order-summary card shadow-sm p-4 mb-4">
        <h2 class="fw-bold mb-3" th:text="#{order.summary.title}">주문 내역</h2>

        <div class="shipping-info card shadow-sm p-4">
            <h3 class="fw-bold mb-3" th:text="#{order.summary.shippingInfo}">배송지 정보</h3>

            <div class="guest" th:if="${user == null}">
                <div class="mb-3">
                    <label class="form-label" th:text="#{order.guest.name}">비회원 이름</label>
                    <input type="text" name="guestName" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label" th:text="#{order.guest.phone}">비회원 전화번호</label>
                    <input type="tel" name="guestPhone" class="form-control" required placeholder="ex) 01012345678">
                </div>

                <div class="mb-3">
                    <label class="form-label" th:text="#{order.guest.password}">비회원 비밀번호</label>
                    <input type="password" name="guestPassword" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" th:text="#{order.receiver}">받는사람 이름</label>
                <input type="text" name="receiverName" class="form-control" required>
            </div>

            <div class="mb-3" th:if="${user != null}">
                <!-- 라벨 -->
                <label class="form-label mb-2" th:text="#{order.available.point}">포인트 사용</label>

                <!-- 입력창 + 포인트 + 버튼 일렬 정렬 -->
                <div class="d-flex align-items-center gap-3">
                    <!-- 입력창 -->
                    <input type="number" name="pointUsed" id="pointUsed" class="form-control" placeholder="사용할 포인트 입력" style="max-width: 200px;">

                    <!-- 현재 포인트 텍스트 -->
                    <div>
                        <span style="font-weight: 500;">사용 가능:</span>
                        <span id="availablePoint" style="font-weight: 700; font-size: 1.1rem;" th:text="${availablePoint}">0</span> <span>포인트</span>
                    </div>

                    <!-- 전액 사용 버튼 -->
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="useAllPoints()">전액 사용</button>
                </div>
            </div>


            <div class="mb-3" th:if="${user != null}">
                    <label class="form-label" th:text="#{order.address.select}">배송지 선택</label>
                    <select class="form-select" id="addressSelector" onchange="fillAddress(this)">
                        <option value="" th:text="#{order.address.select}">주소를 선택하세요</option>
                        <option th:each="addr : ${addressList}"
                            th:data-zipcode="${addr.zipcode}"
                            th:data-road="${addr.roadAddress}"
                            th:data-detail="${addr.detailAddress}"
                            th:data-extra="${addr.extraAddress}"
                            th:data-jibun="${addr.jibunAddress}"
                            th:text="|${addr.alias} - ${addr.roadAddress}|">
                        </option>
                    </select>
            </div>

            <div class="mb-3 row">
                <label class="form-label" th:text="#{order.address.postcode}">우편번호</label>
                <div class="col-md-8">
                    <input type="text" id="zipcode" name="zipcode" class="form-control" placeholder="우편번호" readonly>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="execDaumPostcode()" th:text="#{address.search.button}">우편번호 찾기</button>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-md-6">
                    <label class="form-label" th:text="#{order.address.road}">도로명 주소</label>
                    <input type="text" id="roadAddress" name="roadAddress" class="form-control" placeholder="도로명 주소" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label" th:text="#{order.address.jibun}">지번 주소</label>
                    <input type="text" id="jibunAddress" class="form-control" placeholder="지번 주소" readonly>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-md-6">
                    <label class="form-label" th:text="#{order.address.extra}">참고 항목</label>
                    <input type="text" id="extraAddress" class="form-control" placeholder="참고 항목" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label" th:text="#{order.address.detail}">상세 주소</label>
                    <input type="text" id="detailAddress" name="detailAddress" class="form-control" placeholder="상세 주소">
                </div>
            </div>

            <span id="guide" style="color: #999; display: none;"></span>


            <div class="mb-3">
                <label class="form-label" th:text="#{order.date}">배송 요청 날짜</label>
                <input type="date" name="wantedDateRaw" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label" th:text="#{order.shipping.policy}">배송 방법</label>
                <select name="shippingPolicyId" class="form-select" id="shippingPolicyId">
                    <option value="" disabled selected th:text="#{order.shipping.policy}">배송 정책 선택</option>
                    <option th:each="policy : ${shippingPolicies}"
                            th:value="${policy.id}"
                            th:data-fee="${policy.fee}"
                            th:text="|${policy.name} (+${#numbers.formatInteger(policy.fee, 0, 'COMMA')} #{order.currency.unit})|"
                            th:disabled="${!policy.active}">
                    </option>
                </select>
            </div>

            <div class="text-end mt-4">
                <span class="me-2" th:text="#{order.minimum.price}">최소 주문 금액</span>
                <strong class="me-2" th:text="#{order.total.price}">총 결제 금액:</strong>
                <span id="finalTotal" class="fw-bold fs-5" th:text="|${#numbers.formatInteger(totalAmount, 0, 'COMMA')} #{order.currency.unit}|">0원</span>
                <input type="hidden" id="totalPrice" name="totalPrice" th:value="${totalAmount}" />
            </div>

        </div>
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-dark w-100 py-2" th:text="#{order.button.submit}">결제하기</button>
        </div>
    </div>
    </form>
</div>
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        window.baseAmount = [[${totalAmount}]];
        window.maxPoint = [[${availablePoint}]];
    </script>
    <script src="/js/calculateTotalPrice.js"></script>
</th:block>
</body>
</html>
