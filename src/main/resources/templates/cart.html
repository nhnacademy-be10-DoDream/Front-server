<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <title>장바구니</title>
</head>

<body>
<div layout:fragment="content">
    <table cellspacing="0" cellpadding="0" width="866" align="center" border="0">
        <tr>
            <td valign="top" bgcolor="#ffffff">

                <table class="table_shop_blue" width="100%">
                    <thead>
                    <tr>
                        <th align="center">상품명</th>
                        <th style="text-align: center">가격</th>
                        <th style="text-align: center">수량</th>
                        <th style="text-align: center">쿠폰</th>
                        <th style="text-align: center">포장여부</th>
                        <th style="text-align: center">삭제</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item,stat : ${cartItems}"
                        th:attr="data-sale-price=${item.salePrice}">

                        <td>
                            <a th:href="@{/books/{id}(id=${item.bookId})}" th:text="${item.title}">
                            </a>
                        </td>

                        <td style="text-align: center">
                            <div>
                                정가: <s th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA')} + '원'"></s><br>
                                <span style="color: red;">할인가:<span th:id="'priceDisplay-' + ${item.cartItemId}" th:text="${#numbers.formatInteger(item.salePrice, 0, 'COMMA')} + '원'"></span></span>
                            </div>
                        </td>

                        <td align="center">
                            <form th:action="@{/cart/{cartItemId}(cartItemId=${item.cartItemId})}" method="post" style="display: inline;">
                                <input type="hidden" name="_method" value="put" />
                                <input type="number" class="quantity-input" name="quantity" th:value="${item.quantity}" min="1" style="width: 40px;">
                                <button type="submit">변경</button>
                            </form>
                        </td>


                        <td align="center">
                            <button type="button"
                                    th:attr="data-cart-item-id=${item.cartItemId}, data-book-id=${item.bookId}, data-sale-price=${item.salePrice}"
                                    onclick="openCouponModal(this)">쿠폰 선택</button>
                            <input type="hidden" th:name="'selectedCouponId_' + ${item.cartItemId}" th:id="'selectedCouponId-' + ${item.cartItemId}" />
                        </td>

                        <td align="center">
                            <select class="wrapping-select"
                                    th:attr="data-index=${stat.index}"
                                    onchange="recalculateTotal()">
                                <option data-price="0" value="">선택 안 함</option>
                                <option th:each="wrap : ${wrappingOptions}"
                                        th:value="${wrap.id}"
                                        th:data-price="${wrap.price}"
                                        th:text="${wrap.name + ' (' + #numbers.formatInteger(wrap.price, 0, 'COMMA') + '원)'}">
                                </option>
                            </select>
                        </td>

                        <td align="center">
                            <form th:action="@{/cart/{id}(id=${item.bookId})}" method="post">
                                <button type="submit">삭제</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- 장바구니 요약 정보 -->
                <form th:action="@{/order}" method="post">
                    <div style="width: 866px; margin: 20px auto; border-top: 1px solid #ccc; padding-top: 20px; text-align: center;">
                        <p><strong>총 제품 금액:</strong> <span id="totalProductPrice">0원</span></p>
                        <p><strong>할인 금액:</strong> <span id="totalDiscount">0원</span></p>
                        <p><strong>적립 금액 (10%):</strong> <span id="rewardPoint">0원</span></p>
                        <p><strong>총 주문 금액:</strong> <span id="orderTotal">0원</span></p>
                        <input type="hidden" name="orderTotal" value="0" />

                        <div th:each="item, stat : ${cartItems}">
                            <input type="hidden" th:name="|items[${stat.index}].bookId|" th:value="${item.bookId}" />
                            <input type="hidden" th:name="|items[${stat.index}].title|" th:value="${item.title}" />
                            <input type="hidden" th:name="|items[${stat.index}].price|" th:value="${item.salePrice}" />
                            <input type="hidden" th:name="|items[${stat.index}].quantity|" th:value="${item.quantity}" />
                            <input type="hidden" th:name="|items[${stat.index}].wrappingId|" />
                            <input type="hidden" th:id="'couponId-' + ${stat.index}" th:name="|items[${stat.index}].couponId|" />
                            <input type="hidden" th:id="'finalPrice-' + ${stat.index}" th:name="|items[${stat.index}].finalPrice|" />
                        </div>

                        <button type="submit" style="
                                  display: inline-block;
                                  margin-top: 24px;
                                  padding: 12px 40px;
                                  background: #007bff;
                                  color: #fff;
                                  font-size: 18px;
                                  border-radius: 6px;
                                  text-decoration: none;
                                  font-weight: bold;
                                  transition: background 0.2s;
                                "
                           onmouseover="this.style.background='#0056b3'"
                           onmouseout="this.style.background='#007bff'"
                                onclick="submitOrder()" >주문하기</button>
                    </div>
                </form>
            </td>
        </tr>
    </table>
</div>
</body>
</html>


<script th:inline="javascript">
    const selectedCouponIds = new Set();

    function formatPrice(val) {
        return val.toLocaleString() + '원';
    }

    function recalculateTotal() {
        let totalProductPrice = 0;
        let totalDiscount = 0;
        let totalWrapping = 0;

        document.querySelectorAll('tr[data-sale-price]').forEach(row => {
            const quantityInput = row.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput?.value || 1);

            const priceSpan = row.querySelector('[id^="priceDisplay-"]');
            const salePrice = parseInt(priceSpan?.dataset.originalPrice || 0);
            const finalPrice = parseInt(priceSpan?.innerText.replace(/[^0-9]/g, '') || 0);

            totalProductPrice += salePrice * quantity;
            totalDiscount += (salePrice - finalPrice) * quantity;

            const wrappingSelect = row.querySelector('.wrapping-select');
            const selectedOption = wrappingSelect?.selectedOptions[0];
            const wrappingPrice = selectedOption ? parseInt(selectedOption.dataset.price || 0) : 0;
            totalWrapping += wrappingPrice * quantity;

            const index = wrappingSelect.getAttribute("data-index");
            document.querySelector(`input[name='items[${index}].wrappingId']`).value = selectedOption?.value || "";
        });

        const discountedPrice = totalProductPrice - totalDiscount;
        const orderTotal = discountedPrice + totalWrapping;
        const rewardPoint = Math.floor(orderTotal * 0.1);

        document.querySelector("input[name='orderTotal']").value = orderTotal;
        document.getElementById("totalProductPrice").innerText = formatPrice(totalProductPrice);
        document.getElementById("totalDiscount").innerText = formatPrice(totalDiscount);
        document.getElementById("orderTotal").innerText = formatPrice(orderTotal);
        document.getElementById("rewardPoint").innerText = formatPrice(rewardPoint);
    }

    function openCouponModal(button) {
        const cartItemId = button.dataset.cartItemId;
        const bookId = button.dataset.bookId;
        const couponListDiv = document.getElementById("couponList");
        couponListDiv.innerHTML = "<p>로딩 중...</p>";

        document.getElementById("couponModal").style.display = "block";

        fetch(`/cart/coupons?bookId=${bookId}`)
            .then(response => {
                if (!response.ok) throw new Error("쿠폰 불러오기 실패");
                return response.json();
            })
            .then(coupons => {
                couponListDiv.innerHTML = "";

                const filteredCoupons = coupons.filter(c => !selectedCouponIds.has(c.couponId));

                if (filteredCoupons.length > 0) {
                    filteredCoupons.forEach(coupon => {
                        const couponDiv = document.createElement("div");
                        couponDiv.style.border = "1px solid #ccc";
                        couponDiv.style.padding = "10px";
                        couponDiv.style.marginBottom = "10px";

                        const discountText = coupon.discountValue <= 100
                            ? `${coupon.discountValue}%`
                            : `${coupon.discountValue.toLocaleString()}원`;

                        couponDiv.innerHTML = `
                            <strong>쿠폰 이름:</strong> ${coupon.policyName}<br>
                            <strong>${coupon.discountValue <= 100 ? '할인율' : '할인금액'}:</strong> ${discountText}<br>
                            <strong>최소 구매 금액:</strong> ${coupon.minPurchaseAmount.toLocaleString()}원<br>
                            <strong>최대 할인 금액:</strong> ${coupon.maxDiscountAmount.toLocaleString()}원<br>
                            <button onclick="selectCoupon(${cartItemId}, ${coupon.couponId}, ${coupon.finalPrice})">적용</button>
                        `;
                        couponListDiv.appendChild(couponDiv);
                    });
                } else {
                    couponListDiv.innerHTML = "<p>사용 가능한 쿠폰이 없습니다.</p>";
                }
            })
            .catch(error => {
                couponListDiv.innerHTML = "<p>쿠폰을 불러오는데 실패했습니다.</p>";
            });
    }

    function selectCoupon(cartItemId, couponId, finalPrice) {
        // 기존 같은 쿠폰이 다른 항목에 적용되어 있다면 제거
        document.querySelectorAll("input[id^='selectedCouponId-']").forEach(input => {
            if (input.value === String(couponId)) {
                input.value = ""; // 해당 input 비움
            }
        });


        // 현재 항목에 쿠폰 적용
        document.getElementById("selectedCouponId-" + cartItemId).value = couponId;
        selectedCouponIds.add(couponId);

        const priceSpan = document.getElementById("priceDisplay-" + cartItemId);
        if (priceSpan) {
            priceSpan.innerText = finalPrice.toLocaleString() + "원";
        }

        // 히든 인풋 채우기
        const cartItemRow = document.querySelector(`tr[data-sale-price] [id='priceDisplay-${cartItemId}']`)?.closest("tr");
        if (cartItemRow) {
            const index = cartItemRow.querySelector(".wrapping-select")?.getAttribute("data-index");

            const couponInput = document.getElementById(`couponId-${index}`);
            const finalPriceInput = document.getElementById(`finalPrice-${index}`);
            if (couponInput) couponInput.value = couponId;
            if (finalPriceInput) finalPriceInput.value = finalPrice;
        }

        closeCouponModal();
        recalculateTotal();
    }

    function closeCouponModal() {
        document.getElementById("couponModal").style.display = "none";
    }

    function getSelectedCouponIds() {
        const result = [];

        document.querySelectorAll("input[id^='selectedCouponId-']").forEach(input => {
            const couponId = input.value;
            if (couponId) {
                result.push(parseInt(couponId));
            }
        });

        return result;
    }

    // function submitOrder() {
    //     const couponIds = getSelectedCouponIds();
    //
    //     if (couponIds.length === 0) {
    //         document.getElementById("orderForm").submit();
    //         return;
    //     }
    //
    //     // fetch("/coupons/me/use-multiple", {
    //     //     method: "PUT",
    //     //     headers: {
    //     //         "Content-Type": "application/json"
    //     //     },
    //     //     body: JSON.stringify({ couponIds: couponIds })
    //     // }).then(response => {
    //     //     if (!response.ok) throw new Error("쿠폰 사용 실패");
    //     //     document.getElementById("orderForm").submit();
    //     // }).catch(error => {
    //     //     alert("쿠폰 사용 중 오류가 발생했습니다.");
    //     //     console.error(error);
    //     // });
    // }

    window.onload = () => {
        document.querySelectorAll('[id^="priceDisplay-"]').forEach(span => {
            const rawPrice = span.textContent.replace(/[^0-9]/g, '');
            span.dataset.originalPrice = rawPrice;
        });
        recalculateTotal();
    };
</script>


<!-- 쿠폰 선택 모달 -->
<div id="couponModal" style="display:none; position:fixed; top:20%; left:30%; background:white; border:1px solid #aaa; padding:20px;">
    <h3>쿠폰 선택</h3>
    <div id="couponList"></div>
    <button onclick="closeCouponModal()">닫기</button>
</div>
